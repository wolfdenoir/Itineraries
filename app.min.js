function escapeURL(e){return String(e).replace(/[&<>\-'\/]/g,function(e){var t={"&":"%26","<":"%3C",">":"%3E","-":"-","'":"''","\\":"%5C","[":"%5B","]":"%5D"};return t[e]})}function refreshItins(){if($("#tblItin tbody").empty(),0!=arrStaff.length){var e=$("#weekNo").data("offset");arrStaff.sort(function(e,t){return e.index-t.index});for(var t=0;t<arrStaff.length;t++){var a=$("<td/>",{class:"staff",html:'<div><div><img src="'+arrStaff[t].Picture+'"/></div><div><a href="mailto:'+arrStaff[t].Email+'">'+arrStaff[t].Name+"</a><span>"+arrStaff[t].JobTitle+"</span><span>"+arrStaff[t].Phone+"</span></div></div>",data:{id:arrStaff[t].ID?arrStaff[t].ID:-1,staff:arrStaff[t].Name}}),i=$("<td/>",{class:"itin"}),n=$("<tr/>").append(a,i,i.clone(),i.clone(),i.clone(),i.clone());$("#tblItin tbody").append(n)}if(refreshHolidays(e),$("#btnEdit").hasClass("btn-primary")){var s=$("<input/>",{maxlength:"20",placeholder:"AM",class:"form-control am",html:""}),o=$("<input/>",{maxlength:"20",placeholder:"PM",class:"form-control pm",html:""}),r=$("<div/>",{class:"input-group"}).append(s,o);$(".itin:not(.itin:has(.stat))").append(r),$(".itin .input-group").each(function(e){$(this).attr("tabindex",$("input, button, a").length+e)})}else{var s=$("<span/>",{class:"am",html:""}),o=$("<span/>",{class:"pm",html:""});$(".itin:not(.itin:has(.stat))").append(s,o)}var l;$(".itin .input-group").on("focusin",function(e){if(parseInt($(this).attr("tabindex"))!=l){for(l=parseInt($(this).attr("tabindex"));$(".cellcopy").length>0;)$(".itin").removeAttr("style"),$(".cellcopy").remove();var t=$("<span/>",{class:"input-group-btn cellcopy"}).append($("<button/>",{type:"button",class:"btn btn-default","data-toggle":"tooltip","data-placement":"top",title:"Paste Left",tabindex:$("input, button, a").length,html:'<span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>'}));t.on("click",function(e){copyToCells(this,!1)});var a=$("<span/>",{class:"input-group-btn cellcopy"}).append($("<button/>",{type:"button",class:"btn btn-default","data-toggle":"tooltip","data-placement":"top",title:"Paste Right",tabindex:$("input, button, a").length+1,html:'<span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>'}));a.on("click",function(e){copyToCells(this)}),$(this).parent().width($(this).parent().width()),1==$(this).parent().index()||$(this).parent().prev().is(".itin:has(.stat)")?$(this).append(a):$(this).parent().is(":last-child")||$(this).parent().next().is(".itin:has(.stat)")?$(this).prepend(t):($(this).append(a),$(this).prepend(t)),$('[data-toggle="tooltip"]').tooltip(),e.stopPropagation()}}),$("input.am, input.pm").on("change",editItin),getItinsJSON(e)}}function refreshHolidays(e){for(var t=0;t<arrHoliday.length;t++){var a=new Date(arrHoliday[t].Date),i=getDayOfWeek(e,1),n=getDayOfWeek(e,5);if(a>=i.setHours(0,0,0,0)&&a<=n.setHours(23,59,59,999))for(var s=a.getDay()-1,o=$("<span/>",{class:"stat",html:arrHoliday[t].Title}),r=0;r<arrStaff.length;r++){var l=s+5*r;$(".itin:eq("+l+")").empty(),$(".itin:eq("+l+")").append(o.clone())}}}function editItin(e){$(this).parent().children().addClass("disabled");var t=getDayOfWeek($("#weekNo").data("offset"),$(this).parent().parent().index()),a=($(this).attr("class"),$(this).parent().parent().siblings(":first").data("staff"),$(this).parent().parent().data("id")),i={__metadata:{type:"SP.Data.ItinerariesListItem"},StaffId:$(this).parent().parent().siblings(":first").data("id"),Date:t.toJSON()},n=$(this).siblings("input").val();$(this).hasClass("am")?(i.AM=this.value,i.PM=n):(i.PM=this.value,i.AM=n);var s=_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists(guid'"+_ITIN_LIST_ID+"')/items";void 0!=a&&""!=a?null!=n&&""!=n||null!=this.value&&""!=this.value?$.ajax({url:s+"("+a+")",method:"POST",data:JSON.stringify(i),headers:{"X-RequestDigest":$("#__REQUESTDIGEST").val(),accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-HTTP-Method":"MERGE","IF-MATCH":"*"},context:$(this),success:onUpdateJSON,error:onQueryFailedJSON}):$.ajax({url:s+"("+a+")",method:"POST",headers:{"X-RequestDigest":$("#__REQUESTDIGEST").val(),accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-HTTP-Method":"DELETE","IF-MATCH":"*"},context:$(this),success:onDeleteJSON,error:onQueryFailedJSON}):null!=this.value&&""!=this.value?$.ajax({url:s,method:"POST",data:JSON.stringify(i),headers:{"X-RequestDigest":$("#__REQUESTDIGEST").val(),accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose"},context:$(this),success:onCreateJSON,error:onQueryFailedJSON}):console.log("Warning: Input is empty and there is no existing itemId."),e.stopPropagation()}function copyToCells(e,t){var t=null===t||void 0===t||t,a=$(e).siblings(".am").val(),i=$(e).siblings(".pm").val();t?$(e).parent().parent().nextAll().children().each(function(e){$(this).children(".am").val(a),$(this).children(".pm").val(i),$(this).children(".am").trigger("change")}):$(e).parent().parent().prevUntil(".staff").children().each(function(e){$(this).children(".am").val(a),$(this).children(".pm").val(i),$(this).children(".am").trigger("change")})}function onCreateJSON(e){$(this).parent().parent().data("id",e.d.ID),$(this).parent().children().removeClass("disabled"),console.log("itemID "+e.d.ID+" created")}function onUpdateJSON(e){console.log("ItemID "+$(this).parent().parent().data("id")+" updated."),$(this).parent().children().removeClass("disabled")}function onDeleteJSON(e){console.log("ItemID "+$(this).parent().parent().data("id")+" deleted."),$(this).parent().parent().removeData(),$(this).parent().children().removeClass("disabled")}function resetFields(){$("#itin-main button, #itin-main input").addClass("disabled"),$(".itin").removeData(),$("#btnEdit").hasClass("btn-primary")?$(".am, .pm").val(""):$(".am, .pm").html("")}function enableFields(){$("#itin-main button, #itin-main input").removeClass("disabled"),$("#itin-splash button").removeClass("disabled")}function getItinsJSON(e){if(0!=arrStaff.length){resetFields();for(var t="$filter=(Staff eq '"+escapeURL(arrStaff[0].Name)+"'",a=1;a<arrStaff.length;a++)t+=" or Staff eq '"+escapeURL(arrStaff[a].Name)+"'";var i=_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists(guid'"+_ITIN_LIST_ID+"')/items?$select=ID,StaffId,Staff/Title,Date,AM,PM&$expand=Staff&"+t+") and Date ge DateTime'"+toDateStr(getDayOfWeek(e,0))+"T00:00:00.000Z' and Date le DateTime'"+toDateStr(getDayOfWeek(e,6))+"T23:59:59.999Z'&$orderby=Staff desc&$top=200";console.log(i),$.ajax({url:i,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:onItinsJSON,error:onQueryFailedJSON})}}function toDateStr(e){var t=e.getMonth()+1;t<10&&(t="0"+t);var a=e.getDate();return a<10&&(a="0"+a),e.getFullYear()+"-"+t+"-"+a}function getHolidaysJSON(e){var t=_spPageContextInfo.webAbsoluteUrl+"/HR/_api/web/lists(guid'"+_STAT_LIST_ID+"')/items?$select=Title,Date&$top=100";console.log(t),$.ajax({url:t,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(e){var t=e.d.results;t.length>0&&($.each(t,function(e,t){var a={Title:t.Title,Date:t.Date};arrHoliday.push(a)}),console.log("STAT days loaded."))},error:onQueryFailedJSON})}function onItinsJSON(e){var t=e.d.results;t.length>0?$.each(t,function(e,t){var a=new Date(t.Date),e=a.getDay()-1,i=String(t.Staff.Title).replace(/'/g,"\\'");$(".staff:contains('"+i+"') ~ .itin:eq("+e+")").data("id",t.ID),$("#btnEdit").hasClass("btn-primary")?($(".staff:contains('"+i+"') ~ .itin:eq("+e+") .am").val(t.AM),$(".staff:contains('"+i+"') ~ .itin:eq("+e+") .pm").val(t.PM)):($(".staff:contains('"+i+"') ~ .itin:eq("+e+") .am").html(t.AM),$(".staff:contains('"+i+"') ~ .itin:eq("+e+") .pm").html(t.PM))}):console.log("No itin record found."),enableFields()}function onQueryFailedJSON(e,t,a){null!=e.responseJSON?console.log(e.responseJSON.error.code+": "+e.responseJSON.error.message.value):console.log(e),alert("There was a problem updating the data. Please refresh the page and try agin.")}function getStaffList(e,t){var a="",i="";resetFields(),"staff"==t?i=_spPageContextInfo.webAbsoluteUrl+"/_api/search/query?querytext='PreferredName=\""+String(escapeURL(e)).replace(/-/g,"\\-")+"\"'&selectproperties='PreferredName,PictureURL,JobTitle,WorkPhone,WorkEmail,AccountName'&sourceid='"+_LOCAL_PEOPLE_RESULT_ID+"'":(a=t+'="'+e+'" JobTitle<>"Support" AND (JobTitle:"a*" JobTitle:"b*" JobTitle:"c*" JobTitle:"d*" JobTitle:"e*"JobTitle:"f*" JobTitle:"g*" JobTitle:"h*" JobTitle:"i*" JobTitle:"j*"JobTitle:"k*" JobTitle:"l*" JobTitle:"m*" JobTitle:"n*" JobTitle:"o*"JobTitle:"p*" JobTitle:"q*" JobTitle:"r*" JobTitle:"s*" JobTitle:"t*"JobTitle:"u*" JobTitle:"v*" JobTitle:"w*" JobTitle:"x*" JobTitle:"y*"JobTitle:"z*" JobTitle:"0*" JobTitle:"1*" JobTitle:"2*" JobTitle:"3*"JobTitle:"4*" JobTitle:"5*" JobTitle:"6*" JobTitle:"7*" JobTitle:"8*"JobTitle:"9*")',i=_spPageContextInfo.webAbsoluteUrl+"/_api/search/query?querytext='"+a+"'&sortlist='PreferredName:ascending'&selectproperties='PreferredName,PictureURL,JobTitle,WorkPhone,WorkEmail,AccountName'&sourceid='"+_LOCAL_PEOPLE_RESULT_ID+"'&rowlimit='100'"),$.ajax({url:i,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:onStaffListJSON,error:onQueryFailedJSON})}function onStaffListJSON(e){arrStaff=[],itemCount=0;var t=e.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results;if(t.length>0){if(isLastItem=!1,$.each(t,function(e,a){var i={ID:null,Name:a.Cells.results[2].Value,Picture:null!=a.Cells.results[3].Value?a.Cells.results[3].Value:"/_layouts/15/images/person.gif",Email:a.Cells.results[6].Value,Phone:null!=a.Cells.results[5].Value?a.Cells.results[5].Value:"",JobTitle:a.Cells.results[4].Value,AccountName:a.Cells.results[7].Value,index:e};$.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/web/ensureuser",type:"POST",data:JSON.stringify({logonName:i.AccountName}),headers:{"X-RequestDigest":$("#__REQUESTDIGEST").val(),Accept:"application/json; odata=verbose","content-type":"application/json;odata=verbose"},node:i,success:function(e){i.ID=e.d.Id,arrStaff.push(i),t.length==++itemCount&&(isLastItem=!0,refreshItins())},error:function(e,a,i){null!=e.responseJSON?console.log(e.responseJSON.error.code+": "+e.responseJSON.error.message.value):console.log(e),t.length==++itemCount&&(isLastItem=!0,refreshItins())}})}),$("#itin-main").hasClass("hidden")){$("#itin-main").removeClass("hidden"),$("#itin-splash").addClass("hidden");var a=$("#acStaff");a.detach(),a.appendTo($("#container-grpOption-main"))}}else if($("#itin-splash").hasClass("hidden")){$("#itin-splash").removeClass("hidden"),$("#itin-main").addClass("hidden");var a=$("#acStaff");a.detach(),a.appendTo($("#container-grpOption-splash")),$("#itin-splash h3").html("Sorry, can't find anything... Try something else.")}else $("#itin-splash h3").html("Sorry, can't find anything... Try something else.");enableFields()}function getWeekOf(e){var t=["January","February","March","April","May","June","July","August","September","October","November","December"],a=getDayOfWeek(e,1),i=getDayOfWeek(e,5),n=t[a.getMonth()]+" "+a.getDate()+" to "+t[i.getMonth()]+" "+i.getDate();return n}function getDayOfWeek(e,t){if(t>6||t<0)return void jQuery.error("Day number must be between 0 and 6.");var a=new Date;return a.setDate(a.getDate()+7*e-a.getDay()+t),a}function getTypeaheadTerms(){getDeptTerms(),getStaffTerms(),$("#acStaff .typeahead").typeahead({source:arrTypeahead,updater:function(e){return getStaffList(mapTypeahead[e].name,mapTypeahead[e].type),e}})}function getDeptTerms(){this.session=SP.Taxonomy.TaxonomySession.getTaxonomySession(context),this.termStore=session.getDefaultSiteCollectionTermStore(),this.termSet=this.termStore.getTermSet(_DEPT_TERMSTORE_ID),this.terms=termSet.get_terms(),context.load(session),context.load(termStore),context.load(termSet),context.load(terms),context.executeQueryAsync(Function.createDelegate(this,function(e,t){for(var a=terms.getEnumerator();a.moveNext();){var i=a.get_current(),n=i.get_name(),s={name:n,type:"department"};mapTypeahead[n]=s,arrTypeahead.push(n)}console.log("Department terms loaded."),getOfficeTerms()}),Function.createDelegate(this,this.failedListTaxonomySession))}function getOfficeTerms(){this.termSet=this.termStore.getTermSet(_OFFICE_TERMSTORE_ID),this.terms=termSet.get_terms(),context.load(session),context.load(termStore),context.load(termSet),context.load(terms),context.executeQueryAsync(Function.createDelegate(this,function(e,t){for(var a=terms.getEnumerator();a.moveNext();){var i=a.get_current(),n=i.get_name(),s={name:n,type:"office"};mapTypeahead[n]=s,arrTypeahead.push(n)}console.log("Office terms loaded.")}),Function.createDelegate(this,this.failedListTaxonomySession))}function getStaffTerms(){var e='JobTitle<>"Support" AND (JobTitle:"a*" JobTitle:"b*" JobTitle:"c*" JobTitle:"d*" JobTitle:"e*"JobTitle:"f*" JobTitle:"g*" JobTitle:"h*" JobTitle:"i*" JobTitle:"j*"JobTitle:"k*" JobTitle:"l*" JobTitle:"m*" JobTitle:"n*" JobTitle:"o*"JobTitle:"p*" JobTitle:"q*" JobTitle:"r*" JobTitle:"s*" JobTitle:"t*"JobTitle:"u*" JobTitle:"v*" JobTitle:"w*" JobTitle:"x*" JobTitle:"y*"JobTitle:"z*" JobTitle:"0*" JobTitle:"1*" JobTitle:"2*" JobTitle:"3*"JobTitle:"4*" JobTitle:"5*" JobTitle:"6*" JobTitle:"7*" JobTitle:"8*"JobTitle:"9*")',t=_spPageContextInfo.webAbsoluteUrl+"/_api/search/query?querytext='"+e+"'&selectproperties='PreferredName,AccountName'&sourceid='"+_LOCAL_PEOPLE_RESULT_ID+"'&rowlimit='300'";$.ajax({url:t,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(e){var t=e.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results;t.length>0?($.each(t,function(e,t){var a={name:t.Cells.results[2].Value,AccountName:t.Cells.results[3].Value,type:"staff"};mapTypeahead[t.Cells.results[2].Value]=a,arrTypeahead.push(t.Cells.results[2].Value)}),console.log("Staff terms loaded.")):console.log("No staff terms found.")},error:onQueryFailedJSON})}var _ITIN_LIST_ID="04f89ad9-196d-4398-b745-ccd5cc80a704",_STAT_LIST_ID="f74bcb96-897d-425c-972e-354fcfc99654",_DEPT_TERMSTORE_ID="8ed8c9ea-7052-4c1d-a4d7-b9c10bffea6f",_OFFICE_TERMSTORE_ID="3588dfe5-e02f-4631-b768-ce6137ebbb61",_LOCAL_PEOPLE_RESULT_ID="B09A7990-05EA-4AF9-81EF-EDFAB16C4E31",arrHoliday=[],arrStaff=[],arrTypeahead=[],mapTypeahead={},context=new SP.ClientContext.get_current,web=context.get_web(),user=web.get_currentUser();$(document).ready(function(){context.load(user),context.executeQueryAsync(function(){console.log(user),getTypeaheadTerms(),getHolidaysJSON($("#weekNo").data("offset"))},function(){alert("Connection Failed. Refresh the page and try again. :(")}),$("#weekNo").text(getWeekOf($("#weekNo").data("offset"))),$("#prev").on("click",function(e){if(!$(e.currentTarget).hasClass("disabled")){var t=$("#weekNo").data("offset");t--,$("#weekNo").data("offset",t),$("#weekNo").text(getWeekOf(t)),refreshItins(),e.stopPropagation()}}),$("#next").on("click",function(e){if(!$(e.currentTarget).hasClass("disabled")){var t=$("#weekNo").data("offset");t++,$("#weekNo").data("offset",t),$("#weekNo").text(getWeekOf(t)),refreshItins(),e.stopPropagation()}}),$("#btnEdit").on("click",function(e){if(!$(e.currentTarget).hasClass("disabled")){if(!isLastItem)return void alert("Hold your horses dear! Data is still being crunched... Try again soon!");$(this).hasClass("btn-default")?($(this).removeClass("btn-default"),$(this).addClass("btn-primary"),$(this).html('<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>&nbsp;Editing')):($(this).removeClass("btn-primary"),$(this).addClass("btn-default"),$(this).html('<span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>&nbsp;Viewing')),refreshItins(),e.stopPropagation()}}),$(window).resize(function(){$(".cellcopy").length>0&&($(".itin").removeAttr("style"),$(".cellcopy").remove())}),$('[data-toggle="tooltip"]').tooltip()});