function escapeURL(e){return String(e).replace(/[&<>\-'\/]/g,function(e){var t={"&":"%26","<":"%3C",">":"%3E","-":"\\-","'":"%60","\\":"%5C","[":"%5B","]":"%5D"};return t[e]})}function refreshItins(){if($("#tblItin tbody").empty(),0!=arrStaff.length){for(var e=0;e<arrStaff.length;e++){var t=$("<td/>",{class:"staff",html:'<div><div><img src="'+arrStaff[e].Picture+'"/></div><div><a href="mailto:'+arrStaff[e].Email+'">'+arrStaff[e].Name+"</a><span>"+arrStaff[e].JobTitle+"</span><span>"+arrStaff[e].Phone+"</span></div></div>",data:{id:arrStaff[e].ID?arrStaff[e].ID:-1,staff:arrStaff[e].Name}}),a=$("<td/>",{class:"itin"}),i=$("<tr/>").append(t,a,a.clone(),a.clone(),a.clone(),a.clone());$("#tblItin tbody").append(i)}if($("#btnEdit").hasClass("btn-primary")){var n=$("<input/>",{maxlength:"10",placeholder:"AM",class:"form-control am",html:""}),s=$("<input/>",{maxlength:"10",placeholder:"PM",class:"form-control pm",html:""}),o=$("<div/>",{class:"input-group"}).append(n,s);$(".itin").append(o),$(".itin .input-group").each(function(e){$(this).attr("tabindex",$("input, button, a").length+e)})}else{var n=$("<span/>",{class:"am",html:""}),s=$("<span/>",{class:"pm",html:""});$(".itin").append(n,s)}var r;$(".itin .input-group").on("focusin",function(e){if(parseInt($(this).attr("tabindex"))!=r){for(r=parseInt($(this).attr("tabindex"));$(".cellcopy").length>0;)$(".itin").removeAttr("style"),$(".cellcopy").remove();var t=$("<span/>",{class:"input-group-btn cellcopy"}).append($("<button/>",{type:"button",class:"btn btn-default","data-toggle":"tooltip","data-placement":"top",title:"Flush Left",tabindex:$("input, button, a").length,html:'<span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>'}));t.on("click",function(e){copyToCells(this,!1)});var a=$("<span/>",{class:"input-group-btn cellcopy"}).append($("<button/>",{type:"button",class:"btn btn-default","data-toggle":"tooltip","data-placement":"top",title:"Flush Right",tabindex:$("input, button, a").length+1,html:'<span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>'}));a.on("click",function(e){copyToCells(this)}),$(this).parent().width($(this).parent().width()),1==$(this).parent().index()?$(this).append(a):$(this).parent().is(":last-child")?$(this).prepend(t):($(this).append(a),$(this).prepend(t)),$('[data-toggle="tooltip"]').tooltip(),e.stopPropagation()}}),$("input.am, input.pm").on("change",editItin),getItinsJSON($("#weekNo").data("offset"))}}function editItin(e){$(this).parent().children().addClass("disabled");var t=getDayOfWeek($("#weekNo").data("offset"),$(this).parent().parent().index()),a=($(this).attr("class"),$(this).parent().parent().siblings(":first").data("staff"),$(this).parent().parent().data("id")),i={__metadata:{type:"SP.Data.ItinerariesListItem"},StaffId:$(this).parent().parent().siblings(":first").data("id"),Date:t.toJSON()},n=$(this).siblings("input").val();$(this).hasClass("am")?(i.AM=this.value,i.PM=n):(i.PM=this.value,i.AM=n),void 0!=a&&""!=a?null!=n&&""!=n||null!=this.value&&""!=this.value?$.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/GetByTitle('Itineraries')/items("+a+")",method:"POST",data:JSON.stringify(i),headers:{"X-RequestDigest":$("#__REQUESTDIGEST").val(),accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-HTTP-Method":"MERGE","IF-MATCH":"*"},context:$(this),success:onUpdateJSON,error:onQueryFailedJSON}):$.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/GetByTitle('Itineraries')/items("+a+")",method:"POST",headers:{"X-RequestDigest":$("#__REQUESTDIGEST").val(),accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose","X-HTTP-Method":"DELETE","IF-MATCH":"*"},context:$(this),success:onDeleteJSON,error:onQueryFailedJSON}):null!=this.value&&""!=this.value&&$.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/GetByTitle('Itineraries')/items",method:"POST",data:JSON.stringify(i),headers:{"X-RequestDigest":$("#__REQUESTDIGEST").val(),accept:"application/json;odata=verbose","content-type":"application/json;odata=verbose"},context:$(this),success:onCreateJSON,error:onQueryFailedJSON}),e.stopPropagation()}function copyToCells(e,t){var t=null===t||void 0===t||t;if(1==$(e).parent().parent().index()&&!t||$(e).parent().parent().is(":last-child")&&t)return void console.log("Exeption: There are no inputs in the specified direction.");var a=$(e).siblings(".am").val(),i=$(e).siblings(".pm").val();t?$(e).parent().parent().nextAll().children().each(function(e){$(this).children(".am").val(a),$(this).children(".pm").val(i),$(this).children(".am").trigger("change")}):$(e).parent().parent().prevUntil(".staff").children().each(function(e){$(this).children(".am").val(a),$(this).children(".pm").val(i),$(this).children(".am").trigger("change")})}function onCreateJSON(e){$(this).parent().parent().data("id",e.d.ID),$(this).parent().children().removeClass("disabled"),console.log("itemID "+e.d.ID+" created")}function onUpdateJSON(e){console.log("ItemID "+$(this).parent().parent().data("id")+" updated."),$(this).parent().children().removeClass("disabled")}function onDeleteJSON(e){console.log("ItemID "+$(this).parent().parent().data("id")+" deleted."),$(this).parent().parent().removeData(),$(this).parent().children().removeClass("disabled")}function resetFields(){$("#itin-main button, #itin-main input").addClass("disabled"),$(".itin").removeData(),$("#btnEdit").hasClass("btn-primary")?$(".am, .pm").val(""):$(".am, .pm").html("")}function enableFields(){$("#itin-main button, #itin-main input").removeClass("disabled"),$("#itin-splash button").removeClass("disabled")}function getItinsJSON(e){if(0!=arrStaff.length){resetFields();for(var t="$filter=(Staff eq '"+escapeURL(arrStaff[0].Name)+"'",a=1;a<arrStaff.length;a++)t+=" or Staff eq '"+escapeURL(arrStaff[a].Name)+"'";var i=_spPageContextInfo.webAbsoluteUrl+"/_api/web/lists/GetByTitle('Itineraries')/items?$select=ID,StaffId,Staff/Title,Date,AM,PM&$expand=Staff&"+t+") and Date ge DateTime'"+getDayOfWeek(e,1).toJSON().slice(0,11)+"00:00:00.000Z' and Date le DateTime'"+getDayOfWeek(e,5).toJSON().slice(0,11)+"23:59:59.999Z'&$orderby=Staff desc";$.ajax({url:i,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:onItinsJSON,error:onQueryFailedJSON})}}function onItinsJSON(e){var t=e.d.results;t.length>0?$.each(t,function(e,t){var a=new Date(t.Date),e=a.getDay()-1;$(".staff:contains('"+t.Staff.Title+"') ~ .itin:eq("+e+")").data("id",t.ID),$("#btnEdit").hasClass("btn-primary")?($(".staff:contains('"+t.Staff.Title+"') ~ .itin .am:eq("+e+")").val(t.AM),$(".staff:contains('"+t.Staff.Title+"') ~ .itin .pm:eq("+e+")").val(t.PM)):($(".staff:contains('"+t.Staff.Title+"') ~ .itin .am:eq("+e+")").html(t.AM),$(".staff:contains('"+t.Staff.Title+"') ~ .itin .pm:eq("+e+")").html(t.PM))}):console.log("No itin record found."),enableFields()}function onQueryFailed(e,t){console.log("Request failed."+t.get_message()+"\n"+t.get_stackTrace())}function onQueryFailedJSON(e,t,a){null!=e.responseJSON?console.log(e.responseJSON.error.code+": "+e.responseJSON.error.message.value):console.log(e)}function getStaffList(e,t){var a="",i="";resetFields(),"staff"==t?i=_spPageContextInfo.webAbsoluteUrl+"/_api/search/query?querytext='PreferredName=\""+escapeURL(e)+"\"'&selectproperties='PreferredName,PictureURL,JobTitle,WorkPhone,WorkEmail,AccountName'&sourceid='B09A7990-05EA-4AF9-81EF-EDFAB16C4E31'":(a=t+'="'+e+'" JobTitle<>"Support" AND (JobTitle:"a*" JobTitle:"b*" JobTitle:"c*" JobTitle:"d*" JobTitle:"e*"JobTitle:"f*" JobTitle:"g*" JobTitle:"h*" JobTitle:"i*" JobTitle:"j*"JobTitle:"k*" JobTitle:"l*" JobTitle:"m*" JobTitle:"n*" JobTitle:"o*"JobTitle:"p*" JobTitle:"q*" JobTitle:"r*" JobTitle:"s*" JobTitle:"t*"JobTitle:"u*" JobTitle:"v*" JobTitle:"w*" JobTitle:"x*" JobTitle:"y*"JobTitle:"z*" JobTitle:"0*" JobTitle:"1*" JobTitle:"2*" JobTitle:"3*"JobTitle:"4*" JobTitle:"5*" JobTitle:"6*" JobTitle:"7*" JobTitle:"8*"JobTitle:"9*")',i=_spPageContextInfo.webAbsoluteUrl+"/_api/search/query?querytext='"+a+"'&sortlist='PreferredName:ascending'&selectproperties='PreferredName,PictureURL,JobTitle,WorkPhone,WorkEmail,AccountName'&sourceid='B09A7990-05EA-4AF9-81EF-EDFAB16C4E31'&rowlimit='100'"),$.ajax({url:i,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:onStaffListJSON,error:onQueryFailedJSON})}function onStaffListJSON(e){arrStaff=[];var t=e.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results;if(t.length>0){if(numReadyForEdit=0,isReadyForEdit=!1,$.each(t,function(e,t){var a={ID:null,Name:t.Cells.results[2].Value,Picture:null!=t.Cells.results[3].Value?t.Cells.results[3].Value:"/_layouts/15/images/person.gif",Email:t.Cells.results[6].Value,Phone:null!=t.Cells.results[5].Value?t.Cells.results[5].Value:"",JobTitle:t.Cells.results[4].Value,AccountName:t.Cells.results[7].Value};arrStaff.push(a),$.ajax({url:_spPageContextInfo.webAbsoluteUrl+"/_api/web/ensureuser",type:"POST",data:JSON.stringify({logonName:a.AccountName}),headers:{"X-RequestDigest":$("#__REQUESTDIGEST").val(),Accept:"application/json; odata=verbose","content-type":"application/json;odata=verbose"},indexValue:e,success:function(t){arrStaff[e].ID=t.d.Id,$(".staff").eq(e).data("id",t.d.Id),numReadyForEdit++,arrStaff.length==numReadyForEdit&&(isReadyForEdit=!0)},error:onQueryFailedJSON})}),$("#itin-main").hasClass("hidden")){$("#itin-main").removeClass("hidden"),$("#itin-splash").addClass("hidden");var a=$("#acStaff");a.detach(),a.appendTo($("#container-grpOption-main"))}refreshItins()}else if($("#itin-splash").hasClass("hidden")){$("#itin-splash").removeClass("hidden"),$("#itin-main").addClass("hidden");var a=$("#acStaff");a.detach(),a.appendTo($("#container-grpOption-splash")),$("#itin-splash h3").html("Sorry, can't find anything... Try something else.")}else $("#itin-splash h3").html("Sorry, can't find anything... Try something else.");enableFields()}function getWeekOf(e){var t=["January","February","March","April","May","June","July","August","September","October","November","December"],a=getDayOfWeek(e,1),i=getDayOfWeek(e,5),n=t[a.getMonth()]+" "+a.getDate()+" to "+t[i.getMonth()]+" "+i.getDate();return n}function getDayOfWeek(e,t){if(t>5||t<1)return void jQuery.error("Day number must be between 1 and 5.");var a=new Date;return a.setDate(a.getDate()+7*e-a.getDay()+t),a}function getTypeaheadTerms(){getDeptTerms(),getStaffTerms(),$("#acStaff .typeahead").typeahead({source:arrTypeahead,updater:function(e){return getStaffList(mapTypeahead[e].name,mapTypeahead[e].type),e}})}function getDeptTerms(){this.session=SP.Taxonomy.TaxonomySession.getTaxonomySession(context),this.termStore=session.getDefaultSiteCollectionTermStore(),this.termSet=this.termStore.getTermSet("8ed8c9ea-7052-4c1d-a4d7-b9c10bffea6f"),this.terms=termSet.get_terms(),context.load(session),context.load(termStore),context.load(termSet),context.load(terms),context.executeQueryAsync(Function.createDelegate(this,function(e,t){for(var a=terms.getEnumerator();a.moveNext();){var i=a.get_current(),n=i.get_name(),s={name:n,type:"department"};mapTypeahead[n]=s,arrTypeahead.push(n)}console.log("Department terms loaded."),getOfficeTerms()}),Function.createDelegate(this,this.failedListTaxonomySession))}function getOfficeTerms(){this.termSet=this.termStore.getTermSet("1e0e7cef-a4ea-45c1-aaca-6817c9211330"),this.terms=termSet.get_terms(),context.load(session),context.load(termStore),context.load(termSet),context.load(terms),context.executeQueryAsync(Function.createDelegate(this,function(e,t){for(var a=terms.getEnumerator();a.moveNext();){var i=a.get_current(),n=i.get_name(),s={name:n,type:"office"};mapTypeahead[n]=s,arrTypeahead.push(n)}console.log("Office terms loaded.")}),Function.createDelegate(this,this.failedListTaxonomySession))}function getStaffTerms(){var e='JobTitle<>"Support" AND (JobTitle:"a*" JobTitle:"b*" JobTitle:"c*" JobTitle:"d*" JobTitle:"e*"JobTitle:"f*" JobTitle:"g*" JobTitle:"h*" JobTitle:"i*" JobTitle:"j*"JobTitle:"k*" JobTitle:"l*" JobTitle:"m*" JobTitle:"n*" JobTitle:"o*"JobTitle:"p*" JobTitle:"q*" JobTitle:"r*" JobTitle:"s*" JobTitle:"t*"JobTitle:"u*" JobTitle:"v*" JobTitle:"w*" JobTitle:"x*" JobTitle:"y*"JobTitle:"z*" JobTitle:"0*" JobTitle:"1*" JobTitle:"2*" JobTitle:"3*"JobTitle:"4*" JobTitle:"5*" JobTitle:"6*" JobTitle:"7*" JobTitle:"8*"JobTitle:"9*")',t=_spPageContextInfo.webAbsoluteUrl+"/_api/search/query?querytext='"+e+"'&selectproperties='PreferredName,AccountName'&sourceid='B09A7990-05EA-4AF9-81EF-EDFAB16C4E31'&rowlimit='300'";$.ajax({url:t,type:"GET",headers:{Accept:"application/json; odata=verbose"},success:function(e){var t=e.d.query.PrimaryQueryResult.RelevantResults.Table.Rows.results;t.length>0?($.each(t,function(e,t){var a={name:t.Cells.results[2].Value,AccountName:t.Cells.results[3].Value,type:"staff"};mapTypeahead[t.Cells.results[2].Value]=a,arrTypeahead.push(t.Cells.results[2].Value)}),console.log("Staff terms loaded.")):console.log("No staff terms found.")},error:onQueryFailedJSON})}function recursiveTerms(e,t){var a=t+1,i=e.get_terms();context.load(i),context.executeQueryAsync(function(){for(var t=i.getEnumerator();t.moveNext();){var n=t.get_current(),s=n.get_name();termId=n.get_id();for(var o=0;o<a;o++)termsList+="\t";termsList+=s+": "+termId,e.get_termsCount()>0&&recursiveTerms(n,a)}},function(){})}var arrStaff=[],arrTypeahead=[],mapTypeahead={},context=new SP.ClientContext.get_current,web=context.get_web(),user=web.get_currentUser();$(document).ready(function(){$("#weekNo").text(getWeekOf($("#weekNo").data("offset"))),$("#prev").on("click",function(e){if(!$(e.currentTarget).hasClass("disabled")){var t=$("#weekNo").data("offset");t--,$("#weekNo").data("offset",t),$("#weekNo").text(getWeekOf(t)),getItinsJSON(t),e.stopPropagation()}}),$("#next").on("click",function(e){if(!$(e.currentTarget).hasClass("disabled")){var t=$("#weekNo").data("offset");t++,$("#weekNo").data("offset",t),$("#weekNo").text(getWeekOf(t)),getItinsJSON(t),e.stopPropagation()}}),$("#btnEdit").on("click",function(e){if(!$(e.currentTarget).hasClass("disabled")){if(!isReadyForEdit)return void alert("Hold your horses dear! Data is still being crunched... Try again soon!");$(this).hasClass("btn-default")?($(this).removeClass("btn-default"),$(this).addClass("btn-primary"),$(this).html('<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>&nbsp;Editing')):($(this).removeClass("btn-primary"),$(this).addClass("btn-default"),$(this).html('<span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>&nbsp;Viewing')),refreshItins(),e.stopPropagation()}}),$(window).resize(function(){$(".cellcopy").length>0&&($(".itin").removeAttr("style"),$(".cellcopy").remove())}),context.load(user),context.executeQueryAsync(function(){console.log(user),getTypeaheadTerms()},function(){alert("Connection Failed. Refresh the page and try again. :(")}),$('[data-toggle="tooltip"]').tooltip()});